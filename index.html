<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HỆ THỐNG GHÉP ẢNH LIÊN QUÂN CHUYÊN NGHIỆP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS RESET & BOX MODEL */
        * {
            box-sizing: border-box; /* Fix lỗi tràn chữ/ô */
        }
        /* BASE & FONT (Hiệu ứng nhẹ nhàng) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #111827; /* Nền Tối Sâu, không quá gắt */
            color: #E0E0E0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* HEADER & TITLE (Chữ không quá to) */
        .header-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px 20px;
            background-color: #1f2937; /* Xám Đậm */
            border-radius: 8px;
            border-bottom: 3px solid #3b82f6; /* Xanh Dương Hiện Đại */
            width: 100%;
            max-width: 800px;
        }
        .header-section h1 {
            color: #fff;
            font-size: 2em; /* Giảm kích thước H1 */
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        .header-section p {
            color: #9ca3af;
            font-size: 1em;
            margin-top: 5px;
        }

        /* CONTROL PANEL */
        .control-panel {
            background-color: #1f2937;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        }

        .upload-group, .slider-group {
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px dashed #374151;
        }

        .control-panel label {
            display: block;
            margin-bottom: 8px;
            color: #3b82f6; /* Xanh Dương */
            font-weight: 600;
        }

        .control-panel input[type="file"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #4b5563;
            background-color: #2c3748;
            color: #E0E0E0;
            width: 100%;
            cursor: pointer;
        }

        /* Nút Tải Xuống */
        #downloadButton {
            width: 100%;
            padding: 14px;
            background-color: #10b981; /* Xanh Lá Mượt */
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            margin-top: 10px;
        }
        #downloadButton:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }

        /* GHÉP ẢNH CANVAS */
        #collageContainer {
            position: relative;
            width: 700px; 
            height: 450px;
            margin-top: 20px;
            border: 4px solid #ef4444; /* Viền Đỏ (LQMB) */
            background-color: #000;
            overflow: hidden; 
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }
        
        .collage-image {
            position: absolute;
            user-select: none;
            touch-action: none;
            max-width: none;
        }

        #backgroundImg {
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            object-fit: cover;
            cursor: default;
        }
        
        #characterImg {
            width: 30%; 
            height: auto;
            top: 50px;
            left: 50px;
            z-index: 10;
            cursor: grab; 
        }

        /* Slider */
        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: #4b5563;
            border-radius: 3px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ef4444; /* Đỏ */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(239, 68, 68, 0.6);
        }
        .slider-group span {
            font-weight: normal;
            color: #10b981;
            margin-left: 10px;
        }
        .instructions {
            color: #6ee7b7;
            text-align: center;
            font-size: 0.9em;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dotted #374151;
        }
    </style>
</head>
<body>

    <div class="header-section">
        <h1>HỆ THỐNG GHÉP ẢNH LIÊN QUÂN CHUYÊN NGHIỆP</h1>
        <p>Tải ảnh nền và ảnh nhân vật để tạo tác phẩm độc đáo của riêng bạn.</p>
    </div>

    <div class="control-panel">
        
        <div class="upload-group">
            <label for="bgFile">1. Tải Lên Ảnh Nền (Background):</label>
            <input type="file" id="bgFile" accept="image/*" onchange="loadBackground(event)">
        </div>

        <div class="upload-group">
            <label for="charFile">2. Tải Lên Ảnh Nhân Vật (Ảnh trong suốt PNG được khuyến nghị):</label>
            <input type="file" id="charFile" accept="image/*" onchange="loadCharacter(event)">
        </div>
        
        <div class="slider-group">
            <label for="sizeSlider">3. Điều chỉnh Kích thước Ảnh Nhân vật: <span id="sizeValue">30%</span></label>
            <input type="range" id="sizeSlider" min="10" max="150" value="30" oninput="resizeCharacter(this.value)">
        </div>

        <div class="output-buttons">
            <button id="downloadButton" onclick="exportCollage()">4. XUẤT ẢNH HOÀN CHỈNH (TẢI VỀ)</button>
        </div>
        
        <p class="instructions">
            *Ảnh nhân vật có thể KÉO, THẢ và điều chỉnh kích thước bằng thanh trượt.
        </p>
    </div>

    <div id="collageContainer">
        <img id="backgroundImg" class="collage-image" src="" alt="Ảnh Nền"> 
        <img id="characterImg" class="collage-image" src="" alt="Ảnh Nhân Vật" style="display: none;"> 
    </div>

    <a id="downloadLink" download="LienQuan_Collage_Pro.png"></a>

    <script>
        const container = document.getElementById('collageContainer');
        const backgroundImg = document.getElementById('backgroundImg');
        const characterImg = document.getElementById('characterImg');
        const sizeSlider = document.getElementById('sizeSlider');
        const sizeValueSpan = document.getElementById('sizeValue');

        // --- LOGIC TẢI ẢNH ---
        function loadBackground(event) {
            const file = event.target.files[0];
            if (file) {
                backgroundImg.src = URL.createObjectURL(file);
            }
        }

        function loadCharacter(event) {
            const file = event.target.files[0];
            if (file) {
                characterImg.src = URL.createObjectURL(file);
                // Reset về mặc định
                characterImg.style.display = 'block';
                characterImg.style.width = sizeSlider.value + '%';
                characterImg.style.left = '50px';
                characterImg.style.top = '50px';
                characterImg.style.height = 'auto'; 
                sizeValueSpan.textContent = sizeSlider.value + '%';
            }
        }
        
        // --- LOGIC CHỈNH KÍCH THƯỚC (Slider) ---
        function resizeCharacter(value) {
            characterImg.style.width = value + '%';
            sizeValueSpan.textContent = value + '%';
        }

        // --- LOGIC DRAG (KÉO) VÀ DROP (THẢ) ---
        let active = false;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        let targetElement = null;

        // Bắt đầu kéo
        container.addEventListener("mousedown", dragStart, false);
        container.addEventListener("touchstart", dragStart, false); 
        
        // Kết thúc kéo
        document.addEventListener("mouseup", dragEnd, false);
        document.addEventListener("touchend", dragEnd, false);
        
        // Di chuyển
        document.addEventListener("mousemove", drag, false);
        document.addEventListener("touchmove", drag, false);

        function dragStart(e) {
            if (e.target.id !== 'characterImg') {
                return;
            }
            
            targetElement = e.target;
            const style = window.getComputedStyle(targetElement);
            
            let clientX, clientY;
            if (e.type === "touchstart") {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            // Tính toán offset dựa trên vị trí hiện tại
            initialX = clientX;
            initialY = clientY;
            xOffset = parseFloat(style.left);
            yOffset = parseFloat(style.top);
            
            targetElement.style.cursor = 'grabbing';
            active = true;
        }

        function dragEnd(e) {
            active = false;
            if (targetElement) {
                targetElement.style.cursor = 'grab';
                targetElement = null;
            }
        }

        function drag(e) {
            if (active && targetElement) {
                e.preventDefault();
                
                let clientX, clientY;
                if (e.type === "touchmove") {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                // Tính toán sự thay đổi vị trí
                let dx = clientX - initialX;
                let dy = clientY - initialY;
                
                // Cập nhật vị trí mới
                let currentX = xOffset + dx;
                let currentY = yOffset + dy;
                
                targetElement.style.left = currentX + 'px';
                targetElement.style.top = currentY + 'px';
            }
        }


        // --- LOGIC XUẤT ẢNH (Dùng html2canvas) ---

        function exportCollage() {
            if (!backgroundImg.src || characterImg.style.display === 'none') {
                alert("❌ Vui lòng tải lên cả Ảnh Nền và Ảnh Nhân Vật trước khi xuất.");
                return;
            }
            
            document.getElementById('downloadButton').textContent = 'Đang xử lý...';
            document.getElementById('downloadButton').disabled = true;

            html2canvas(container, {
                allowTaint: true,
                useCORS: true,
                scale: 2 
            }).then(function(canvas) {
                const link = document.getElementById('downloadLink');
                
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                document.getElementById('downloadButton').textContent = '✅ XUẤT ẢNH HOÀN CHỈNH (TẢI VỀ)';
                document.getElementById('downloadButton').disabled = false;
            });
        }
    </script>

</body>
</html>
